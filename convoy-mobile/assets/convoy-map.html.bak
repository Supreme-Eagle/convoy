<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Convoy Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .leaflet-container {
      background: #020617;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore,
    collection,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const map = L.map("map").setView([19.0760, 72.8777], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap",
  }).addTo(map);

  const markers = new Map();

  const ridersCol = collection(db, "convoyGroups", "default-group", "riders");

  onSnapshot(ridersCol, (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      const id = change.doc.id;
      const data = change.doc.data();
      if (!data.lat || !data.lng) return;

      if (change.type === "removed") {
        const m = markers.get(id);
        if (m) {
          map.removeLayer(m);
          markers.delete(id);
        }
        return;
      }

      const latLng = [data.lat, data.lng];
      if (markers.has(id)) {
        markers.get(id).setLatLng(latLng);
      } else {
        const m = L.marker(latLng).addTo(map);
        m.bindPopup(data.name || id);
        markers.set(id, m);
      }
    });
  });
</script>
</body>
</html>
